---
title: 【洛谷-P4147】玉蟾宫
publishDate: 2021-11-06
description: '求解最大子矩形问题。'
tags:
  - oi_solution

language: '中文'
---

# 题意

给定 $n\times m$ 的矩阵，其中的若干个格子是障碍。

求最大的不包含障碍点的子矩形面积。

$1\leq n, m\leq 1000$.

# 法一

## 分析

每个可能作为答案的矩形，其四周一定都紧邻障碍块。

考虑何时将一个矩形统计进答案，能在 $\mathcal{O}(n^2)$ 的时间复杂度要求内做到不重不漏。

我们**将每个需要统计的矩形，与紧邻其上边的障碍绑定，并在障碍对应的列的最靠下的矩形内的点进行统计**。

如下图，黑色代表障碍。红色矩形会在两个蓝点被统计到，绿色矩形在黄点被统计到。

<img src="https://cdn.tonyyin.top/2021/11/05/f04c6921c45e8.png" style="zoom:50%;" />

对每个点而言，与其绑定的矩形，一定有：**从这个点向上遇到第一个障碍的距离为高**。

于是高边已经确定，只需要知道向左向右能整体移动多少，可以在枚举时动态维护这个信息。

这也叫**悬线法**；悬线是上端覆盖了一个障碍点的竖线；相当于枚举每条悬线。

## 实现

先预处理。从每个点出发，向左/向右走，找到最远的且不是障碍的点。

先枚举行，再枚举列。对于非障碍点 $(i, j)$，若 $(i-1, j)$ 也不是障碍点，则更新这条高线能左右移动的距离。

计算 $(i, j)$ 对应的矩形面积，用最大宽度 $\times$ 高即可。

## 代码

```cpp
const int MAXN = 1e3 + 10;
int n, m, mapp[MAXN][MAXN];
int l[MAXN][MAXN], r[MAXN][MAXN];//(i, j)向左或向右走，能到达的最靠边的点的纵坐标
int up[MAXN][MAXN];//(i, j)向上走最多走多少步（不能走是1步
int main() {
	scanf("%d%d", &n, &m);
	for(int i = 1; i <= n; i++) {
		for(int j = 1; j <= m; j++) {
			char ch; cin >> ch;
			mapp[i][j] = up[i][j] = (ch == 'F');
			l[i][j] = r[i][j] = j;
		}
	}
	for(int i = 1; i <= n; i++) {
		for(int j = 2; j <= m; j++) {
			if(mapp[i][j] == 1 && mapp[i][j - 1] == 1) l[i][j] = l[i][j - 1];
		}
	}
	for(int i = 1; i <= n; i++) {
		for(int j = m - 1; j >= 1; j--) {
			if(mapp[i][j] == 1 && mapp[i][j + 1] == 1) r[i][j] = r[i][j + 1];
		}
	}
	int ans = 0;
	for(int i = 1; i <= n; i++) {
		for(int j = 1; j <= m; j++) {
			//要维护向上一整段的 左边/右边限制
			if(i > 1 && mapp[i][j] == 1 && mapp[i - 1][j] == 1) {
				r[i][j] = min(r[i][j], r[i - 1][j]);
				l[i][j] = max(l[i][j], l[i - 1][j]);
				up[i][j] = up[i - 1][j] + 1;
			}
			ans = max(ans, (r[i][j] - l[i][j] + 1) * up[i][j]);
		}
	}
	cout << 3 * ans << endl;
	return 0;
}
```

# 法二

类似地，考虑**单调栈**做法。

定义 $f(i, j)$ 表示从 $(i, j)$ 向上一直走，直到碰到障碍，**最多能走多少格**。容易预处理。

分开处理每行。**单调栈维护 $f$ 递增**。

具体地，设当前正在处理第 $i$ 行，遇到了点 $(i, j)$.

向单调栈内插入 $(i, j)$ 前，要把所有 $f_{i, k}>f_{i, j}$ 的点弹出。弹出 $f_{i, k}$ 时，将面积为 $f_{i,k}\times (j-k)$ 的矩形统计。

<img src="https://cdn.tonyyin.top/2021/11/06/a96a9648d113f.png" style="zoom:50%;" />

如图。
